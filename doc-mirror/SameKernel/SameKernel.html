<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<link rel="shortcut icon" href="/htdocs/favicon.ico">
<script type="text/javascript" src="/htdocs/bugstatus.js"></script>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta name="robots" content="noindex,nofollow">

<title>SameKernel - Debian Wiki</title>
<script type="text/javascript" src="/htdocs/common/js/common.js"></script>


<link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="/htdocs/debwiki/css/common.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="/htdocs/debwiki/css/print.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="/htdocs/debian-wiki-1.0.css">

<!-- css only for MS IE6/IE7 browsers -->
<!--[if lt IE 8]>
   <link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="/htdocs/debwiki/css/msie.css">
<![endif]-->



<link rel="alternate" type="application/wiki" title="Edit" href="/SameKernel?action=edit">

<link rel="Start" href="/FrontPage">
<link rel="Alternate" title="Wiki Markup" href="/SameKernel?action=raw">
<link rel="Alternate" media="print" title="Print View" href="/SameKernel?action=print">
<link rel="Appendix" title="3.2.51-2013.10.29-compilation-difffiles.txt" href="/SameKernel?action=AttachFile&amp;do=view&amp;target=3.2.51-2013.10.29-compilation-difffiles.txt">
<link rel="Appendix" title="3.2.51-2013.10.29-compilation-samefiles.txt" href="/SameKernel?action=AttachFile&amp;do=view&amp;target=3.2.51-2013.10.29-compilation-samefiles.txt">
<link rel="Appendix" title="ac97_bus.diff" href="/SameKernel?action=AttachFile&amp;do=view&amp;target=ac97_bus.diff">
<link rel="Appendix" title="aes-x86_64.diff" href="/SameKernel?action=AttachFile&amp;do=view&amp;target=aes-x86_64.diff">
<link rel="Appendix" title="aes-x86_64.ko.1" href="/SameKernel?action=AttachFile&amp;do=view&amp;target=aes-x86_64.ko.1">
<link rel="Appendix" title="aes-x86_64.ko.2" href="/SameKernel?action=AttachFile&amp;do=view&amp;target=aes-x86_64.ko.2">
<link rel="Appendix" title="mac80211.diff" href="/SameKernel?action=AttachFile&amp;do=view&amp;target=mac80211.diff">
<link rel="Appendix" title="snd-usb-usx2y.diff" href="/SameKernel?action=AttachFile&amp;do=view&amp;target=snd-usb-usx2y.diff">
<link rel="Appendix" title="vmlinuz-ovh-difference-notes.txt" href="/SameKernel?action=AttachFile&amp;do=view&amp;target=vmlinuz-ovh-difference-notes.txt">
<link rel="Search" href="/FindPage">
<link rel="Index" href="/TitleIndex">
<link rel="Glossary" href="/WordIndex">
<link rel="Help" href="/HelpOnFormatting">
</head>

<body  lang="en" dir="ltr">
<div id="page" lang="en" dir="ltr">

<ul id="pagelocation">
<li><a class="backlink" href="/SameKernel?action=fullsearch&amp;context=180&amp;value=linkto%3A%22SameKernel%22" rel="nofollow" title="Click to do a full-text search for this title">SameKernel</a></li>
</ul>
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span><p class="line867">SameKernel - Deterministic Kernel - allows to <strong>build Kernel</strong> in <a href="/ReproducibleBuilds">Verifiable</a> (reproducible, deterministic) way - in order to be sure that .deb indeed matches the source code of kernel without heaving added backdoors/viruses during or after compilation. <span class="anchor" id="line-4"></span><span class="anchor" id="line-5"></span><p class="line867"><div class="table-of-contents"><p class="table-of-contents-heading">Contents<ol><li>
<a href="#Current_status">Current status</a></li><li>
<a href="#Goal">Goal</a></li><li>
<a href="#Optional_Grsecurity">Optional Grsecurity</a></li><li>
<a href="#Releases_and_Downloads">Releases and Downloads</a></li><li>
<a href="#Install_kernel_from_SameKernel">Install kernel from SameKernel</a></li><li>
<a href="#Progress">Progress</a></li><li>
<a href="#Build">Build</a><ol><li>
<a href="#Prepare_dependencies_for_Build">Prepare dependencies for Build</a></li><li>
<a href="#Create_user_for_kernel_build">Create user for kernel build</a></li><li>
<a href="#Get_and_build_dpkg">Get and build dpkg</a></li><li>
<a href="#Run_kernel_compilation">Run kernel compilation</a></li></ol></li><li>
<a href="#How_this_works">How this works</a></li><li>
<a href="#Trust_chain">Trust chain</a></li><li>
<a href="#FAQ">FAQ</a></li><li>
<a href="#Bugs">Bugs</a><ol><li>
<a href="#bug1_.5Blow.5D_.5Bopen.5D_gzip_problem_while_building_from_source">bug1 [low] [open] gzip problem while building from source</a></li><li>
<a href="#bug2_.5Bvery-low.5D_.5Bfixed.3F.5D_Headers_checksum_not_matching_since_fixdep_has_other_gcc_name">bug2 [very-low] [fixed?] Headers checksum not matching since fixdep has other gcc name</a></li></ol></li><li>
<a href="#Test">Test</a></li></ol></li></ol></div> <span class="anchor" id="line-6"></span><span class="anchor" id="line-7"></span><p class="line867">
<h2 id="Current_status">Current status</h2>
<span class="anchor" id="line-8"></span><span class="anchor" id="line-9"></span><p class="line867"><img alt="icon/ver8.png" class="attachment" src="/icon?action=AttachFile&amp;do=get&amp;target=ver8.png" title="icon/ver8.png" /> beta-testing as of 2014-02-10: <span class="anchor" id="line-10"></span><ul><li><p class="line862">This is a beta-version. <a href="/Mempo">Mempo</a> team will help you on <a class="irc" href="irc://irc.oftc.net/#mempo">irc://irc.oftc.net/#mempo</a> (or <a class="http" href="http://webchat.oftc.net/?randomnick=1&amp;channels=debian-kernel%2Cmempo&amp;uio=MT11bmRlZmluZWQb1">chat-webpage</a>(sometimes allows Tor) or see: <a href="/Mempo#priv">anonymous</a>) please wait up to 48 hours for our reply! <span class="anchor" id="line-11"></span></li><li>Linux kernel only, testing on amd64 (and i386?) <span class="anchor" id="line-12"></span></li><li><p class="line862">Includes by default <strong><a href="/grsecurity">grsecurity</a></strong>, but that can be easily removed  <span class="anchor" id="line-13"></span><span class="anchor" id="line-14"></span></li></ul><p class="line867"><strong>News:</strong> <a class="https" href="https://github.com/mempo/deterministic-kernel/commits/master">https://github.com/mempo/deterministic-kernel/commits/master</a> <img alt=":)" height="16" src="/htdocs/debwiki/img/smile.png" title=":)" width="16" /> and <a class="irc" href="irc://irc.debian.org/#mempo">#mempo</a> <span class="anchor" id="line-15"></span><span class="anchor" id="line-16"></span><p class="line867">
<h2 id="Goal">Goal</h2>
<span class="anchor" id="line-17"></span><span class="anchor" id="line-18"></span><p class="line874">Users should be able to rebuild identical kernel that matches the distributed .deb files, to know that they do not contain a virus added on top of the source code. <span class="anchor" id="line-19"></span><span class="anchor" id="line-20"></span><p class="line867"><span class="anchor" id="grsecurity"></span> <span class="anchor" id="line-21"></span>
<h2 id="Optional_Grsecurity">Optional Grsecurity</h2>
<span class="anchor" id="line-22"></span><p class="line862">In our SameKernel script, <a href="/grsecurity">grsecurity</a> is enabled by default; <span class="anchor" id="line-23"></span><span class="anchor" id="line-24"></span><p class="line862">To disable it, just remove grsecurity line in script's <a class="https" href="https://github.com/mempo/deterministic-kernel/blob/master/kernel-build/linux-mempo/sources.list">sources.list</a>) and then run the build. <span class="anchor" id="line-25"></span><span class="anchor" id="line-26"></span><p class="line867"><img alt="/!\" height="16" src="/htdocs/debwiki/img/alert.png" title="/!\" width="16" /> To fully use Grsecurity kernel you <strong>must</strong> follow steps in <a href="/SameKernel#install">#install</a>! <span class="anchor" id="line-27"></span><span class="anchor" id="line-28"></span><p class="line867"><em>(Note to editors: please leave this section/anchor even if this topic would be moved)</em> <span class="anchor" id="line-29"></span><span class="anchor" id="line-30"></span><p class="line867"><span class="anchor" id="download"></span> <span class="anchor" id="line-31"></span>
<h2 id="Releases_and_Downloads">Releases and Downloads</h2>
<span class="anchor" id="line-32"></span><span class="anchor" id="line-33"></span><p class="line862">Version <a class="https" href="https://github.com/mempo/deterministic-kernel/tree/v0.1.25-rc2">v0.1.25-rc2</a>  <span class="anchor" id="line-34"></span><ul><li><p class="line862">wheezy, with <strong>grsecurity</strong>/mempo, variant "<a class="nonexistent" href="/Mempo/#variant-good">good</a>" <span class="anchor" id="line-35"></span><ul><li><p class="line862">linux-image-3.2.54-grsec-mempo.good.0.1.25_02_amd64.deb = sha256:<tt>589a30c6902679d0e9e359ae218a03d1876bcc6eb1049b60c823a45191e9cad9</tt> <a class="http" href="http://p.suchdig.com/p/cjn.deb">mirror1</a>  <span class="anchor" id="line-36"></span></li><li><p class="line862">linux-headers-3.2.54-grsec-mempo.good.0.1.25_02_amd64.deb = sha256:<tt>2c52b8d6c4a9f0de9371ce16e256cbac781c15191b67cf997e17426b96043d82</tt> <a class="http" href="http://p.suchdig.com/p/cje.deb">mirror1</a>  <span class="anchor" id="line-37"></span></li></ul></li><li>wheezy, without grsecurity  <span class="anchor" id="line-38"></span><ul><li>not tested yet (TODO) <span class="anchor" id="line-39"></span><span class="anchor" id="line-40"></span></li></ul></li></ul><p class="line867"><span class="anchor" id="install"></span> <span class="anchor" id="line-41"></span>
<h2 id="Install_kernel_from_SameKernel">Install kernel from SameKernel</h2>
<span class="anchor" id="line-42"></span><ul><li><p class="line862">Get the .deb files either from <a href="/SameKernel#download">download</a> or <a href="/SameKernel#build">build</a>. <span class="anchor" id="line-43"></span></li><li><p class="line862">Read about <a href="/SameKernel#bugs">known bugs</a> <span class="anchor" id="line-44"></span></li><li><p class="line862">Install them with <tt>dpkg&nbsp;-i</tt> thefiles.deb <span class="anchor" id="line-45"></span></li><li><p class="line891"><img alt="/!\" height="16" src="/htdocs/debwiki/img/alert.png" title="/!\" width="16" /> For grsecurity version you <strong>must</strong> run the <a class="https" href="https://wiki.debian.org/grsecurity/setfattr">setfattr script for grsecurity</a> (and other instructions there - enable user_xattr) or otherwise JIT-using programs like java, python, firefox, icedove etc., will be prohibited from running! (<strong>tip:</strong> if you do not have internet or browser is not working already, remember the script to fix firefox is located also <strong>in your local copy</strong> of SameKernel/deterministic-kernel, search for that filename e.g. in directory apps/.) <span class="anchor" id="line-46"></span></li><li><p class="line862">if you are interested in security for more kernel-related and other tools see: <a href="/Mempo#install">Mempo#install</a> <span class="anchor" id="line-47"></span><span class="anchor" id="line-48"></span></li></ul><p class="line867">
<h2 id="Progress">Progress</h2>
<span class="anchor" id="line-49"></span><span class="anchor" id="line-50"></span><p class="line874">Steps of this project: <span class="anchor" id="line-51"></span><ul><li><p class="line891"><img alt="(./)" height="16" src="/htdocs/debwiki/img/checkmark.png" title="(./)" width="16" /> Step 1 configure kernel build to create identical intermittent files: .o <span class="anchor" id="line-52"></span></li><li><p class="line891"><img alt="(./)" height="16" src="/htdocs/debwiki/img/checkmark.png" title="(./)" width="16" /> Step 2 configure kernel build to create identical final files: .ko <span class="anchor" id="line-53"></span></li><li><p class="line891"><img alt="(./)" height="16" src="/htdocs/debwiki/img/checkmark.png" title="(./)" width="16" /> Step 3 identical .gz files (docs?) <span class="anchor" id="line-54"></span></li><li><p class="line891"><img alt="(./)" height="16" src="/htdocs/debwiki/img/checkmark.png" title="(./)" width="16" /> Step 4 have identical all files and vmlinux including <a class="http" href="http://kernelnewbies.org/vmlinux/asm-notes">vmlinux .notes</a> <span class="anchor" id="line-55"></span></li><li><p class="line891"><img alt="(./)" height="16" src="/htdocs/debwiki/img/checkmark.png" title="(./)" width="16" /> Step 5 have identical .deb files on the same machine <span class="anchor" id="line-56"></span></li><li><p class="line891"><img alt="(./)" height="16" src="/htdocs/debwiki/img/checkmark.png" title="(./)" width="16" /> Step 6 have identical .deb files on different machines <img alt=":-)" height="16" src="/htdocs/debwiki/img/smile.png" title=":-)" width="16" /> (this works, provided username <strong>kernelbuild</strong> and directory <strong>/home/kernelbuild/deterministic-kernel/</strong>) <span class="anchor" id="line-57"></span></li><li><p class="line891"><img alt="(./)" height="16" src="/htdocs/debwiki/img/checkmark.png" title="(./)" width="16" /> Step 6b fix varying xz header/tail between some machines ( <a href="/SameKernel/Test#v0.1.23-rc1_buildA">/Test#v0.1.23-rc1_buildA</a> ) <span class="anchor" id="line-58"></span></li><li>Step 7a remove requirement of having same directory <span class="anchor" id="line-59"></span></li><li>Step 7b remove requirement of having same username <span class="anchor" id="line-60"></span></li><li>Step 8 test if hostname, and timezone are ignored <span class="anchor" id="line-61"></span></li><li>Step 9 any other differences between alpha-testers doing the verification <span class="anchor" id="line-62"></span><span class="anchor" id="line-63"></span></li></ul><p class="line867"><strong>See general instructions for all programs</strong>: <a href="/ReproducibleBuilds">ReproducibleBuilds</a> . <span class="anchor" id="line-64"></span><span class="anchor" id="line-65"></span><p class="line874">We created a script that does this deterministic build in a bit more automated way with added: <span class="anchor" id="line-66"></span><ul><li>verification of downloaded sources (check against hardcoded in script list of expected checksums of sources; also check PGP signature with hardcoded public key of kernel developers) <span class="anchor" id="line-67"></span></li><li><p class="line862">apply security patches for the <a href="/Mempo">Mempo</a> subproject <span class="anchor" id="line-68"></span></li><li><p class="line862">grsecurity patch - <a class="http" href="http://grsecurity.net/">http://grsecurity.net/</a> <span class="anchor" id="line-69"></span></li><li>misc patches if needed (e.g. quick fixes regarding security) <span class="anchor" id="line-70"></span><span class="anchor" id="line-71"></span></li></ul><p class="line874">This page should be usable for everyone in Debian, and script we're writing will be later easy to run in pure-Debian mode too. <span class="anchor" id="line-72"></span><span class="anchor" id="line-73"></span><p class="line867"><span class="anchor" id="build"></span> <span class="anchor" id="line-74"></span>
<h2 id="Build">Build</h2>
<span class="anchor" id="line-75"></span><span class="anchor" id="line-76"></span><p class="line874">Build from sources easily - get the software and publish (PGP-signed) cheksums confirmation so that other users can trust the binary *.deb we publish. <span class="anchor" id="line-77"></span><span class="anchor" id="line-78"></span><p class="line867"><img alt="/!\" height="16" src="/htdocs/debwiki/img/alert.png" title="/!\" width="16" /> Extra tools that are not-standard-wheezy and are installed globally: <span class="anchor" id="line-79"></span><ul><li><p class="line862">GNU gettext &gt;= 0.18.2 (install them from official debian-wheezy backports) <span class="anchor" id="line-80"></span></li></ul><p class="line867"><img alt="/!\" height="16" src="/htdocs/debwiki/img/alert.png" title="/!\" width="16" /> Extra tools that do not need any non-standard global changes: <span class="anchor" id="line-81"></span><ul><li><p class="line862">User local installation of dpkg <a class="http" href="http://anonscm.debian.org/gitweb/?p=reproducible/dpkg.git;a=shortlog;h=refs/heads/pu/reproducible_builds">pu/reproducible_builds</a> - instructions below <span class="anchor" id="line-82"></span></li><li><p class="line862">As root from normal repository install <strong>faketime</strong> (in <a href="/DebianWheezy">wheezy</a>) and other common programs <span class="anchor" id="line-83"></span><span class="anchor" id="line-84"></span></li></ul><p class="line867">
<h3 id="Prepare_dependencies_for_Build">Prepare dependencies for Build</h3>
<span class="anchor" id="line-85"></span><span class="anchor" id="line-86"></span><p class="line874">As root : <span class="anchor" id="line-87"></span><span class="anchor" id="line-88"></span><span class="anchor" id="line-89"></span><pre><span class="anchor" id="line-1"></span>apt-get install faketime time git build-essential libncurses5-dev libncursesw5-dev kernel-package md5deep gcc-4.7-plugin-dev g++ make time automake pkg-config flex</pre><span class="anchor" id="line-90"></span><span class="anchor" id="line-91"></span><p class="line867">
<h3 id="Create_user_for_kernel_build">Create user for kernel build</h3>
<span class="anchor" id="line-92"></span><p class="line867"><img alt="/!\" height="16" src="/htdocs/debwiki/img/alert.png" title="/!\" width="16" /> At this moment, to get the same *.deb kernel files on different machines, build must be ran on the same user! <span class="anchor" id="line-93"></span><span class="anchor" id="line-94"></span><p class="line862">Create unix user <strong>kernelbuild</strong>. <span class="anchor" id="line-95"></span><span class="anchor" id="line-96"></span><p class="line867"><span class="anchor" id="dpkg"></span> <span class="anchor" id="line-97"></span>
<h3 id="Get_and_build_dpkg">Get and build dpkg</h3>
<span class="anchor" id="line-98"></span><span class="anchor" id="line-99"></span><p class="line862">We are using Lunar's branch of dpkg: <a class="http" href="http://anonscm.debian.org/gitweb/?p=reproducible/dpkg.git;a=shortlog;h=refs/heads/pu/reproducible_builds">pu/reproducible_builds</a>. We need GNU gettext &gt;= 0.18.2, therefore on wheezy please add: <span class="anchor" id="line-100"></span><span class="anchor" id="line-101"></span><span class="anchor" id="line-102"></span><pre><span class="anchor" id="line-1-1"></span>http://''YOURMIRROR''.debian.org/debian wheezy-backports main</pre><span class="anchor" id="line-103"></span><p class="line874">to /etc/apt/sources.list and run: <span class="anchor" id="line-104"></span><span class="anchor" id="line-105"></span><span class="anchor" id="line-106"></span><span class="anchor" id="line-107"></span><pre><span class="anchor" id="line-1-2"></span># aptitude update
<span class="anchor" id="line-2"></span># aptitude install -t wheezy-backports gettext autopoint</pre><span class="anchor" id="line-108"></span><p class="line862">Please use <a href="/Mempo">Mempo</a>'s script: <a class="https" href="https://github.com/mempo/mempo-deb/tree/master/pack/dpkg">https://github.com/mempo/mempo-deb/tree/master/pack/dpkg</a> that will fetch, build and install reproducible-dpkg <strong>locally</strong> (no need to upgrade your system wide dpkg) <em>(it will <strong>delete</strong> our old directory in home without asking)</em> <span class="anchor" id="line-109"></span><span class="anchor" id="line-110"></span><span class="anchor" id="line-111"></span><span class="anchor" id="line-112"></span><span class="anchor" id="line-113"></span><span class="anchor" id="line-114"></span><pre><span class="anchor" id="line-1-3"></span>cd ~
<span class="anchor" id="line-2-1"></span>rm -rf mempo-deb/
<span class="anchor" id="line-3"></span>git clone https://github.com/mempo/mempo-deb
<span class="anchor" id="line-4"></span>cd mempo-deb/pack/dpkg</pre><span class="anchor" id="line-115"></span><span class="anchor" id="line-116"></span><p class="line874">Verify version of git repository with the command: <span class="anchor" id="line-117"></span><span class="anchor" id="line-118"></span><span class="anchor" id="line-119"></span><pre><span class="anchor" id="line-1-4"></span>git tag -v `git describe --tags`</pre><span class="anchor" id="line-120"></span><p class="line874">Build and install reproducible-dpkg. <span class="anchor" id="line-121"></span><span class="anchor" id="line-122"></span><span class="anchor" id="line-123"></span><pre><span class="anchor" id="line-1-5"></span>./build-and-install-locally.sh</pre><span class="anchor" id="line-124"></span><span class="anchor" id="line-125"></span><span class="anchor" id="line-126"></span><p class="line867">
<h3 id="Run_kernel_compilation">Run kernel compilation</h3>
<span class="anchor" id="line-127"></span><span class="anchor" id="line-128"></span><p class="line862">In home directory run <em>(it will <strong>delete</strong> our old directory in home without asking)</em> <span class="anchor" id="line-129"></span><span class="anchor" id="line-130"></span><span class="anchor" id="line-131"></span><span class="anchor" id="line-132"></span><span class="anchor" id="line-133"></span><span class="anchor" id="line-134"></span><pre><span class="anchor" id="line-1-6"></span>cd ~
<span class="anchor" id="line-2-2"></span>rm -rf deterministic-kernel/
<span class="anchor" id="line-3-1"></span>git clone https://github.com/mempo/deterministic-kernel.git
<span class="anchor" id="line-4-1"></span>cd deterministic-kernel/</pre><span class="anchor" id="line-135"></span><p class="line874">Verify version of git repository with the command: <span class="anchor" id="line-136"></span><span class="anchor" id="line-137"></span><span class="anchor" id="line-138"></span><pre><span class="anchor" id="line-1-7"></span>git tag -v `git describe --tags`</pre><span class="anchor" id="line-139"></span><p class="line874">Build: <span class="anchor" id="line-140"></span><span class="anchor" id="line-141"></span><span class="anchor" id="line-142"></span><pre><span class="anchor" id="line-1-8"></span>bash run.sh</pre><span class="anchor" id="line-143"></span><p class="line862">press ENTER to confirm (e.g. the download) and then kernel should build <img alt=":)" height="16" src="/htdocs/debwiki/img/smile.png" title=":)" width="16" /> <span class="anchor" id="line-144"></span><span class="anchor" id="line-145"></span><p class="line867"><img alt="/!\" height="16" src="/htdocs/debwiki/img/alert.png" title="/!\" width="16" /> (Or better execute this by hand and check sha1sum of git version) <span class="anchor" id="line-146"></span><span class="anchor" id="line-147"></span><p class="line867">
<h2 id="How_this_works">How this works</h2>
<span class="anchor" id="line-148"></span><span class="anchor" id="line-149"></span><p class="line874">Following fixes are applied: <span class="anchor" id="line-150"></span><span class="anchor" id="line-151"></span><ul><li>(TODO update this doc) <span class="anchor" id="line-152"></span></li><li><p class="line891"><img alt="(./)" height="16" src="/htdocs/debwiki/img/checkmark.png" title="(./)" width="16" /> Set anv options like USER, HOST <span class="anchor" id="line-153"></span></li><li><p class="line891"><img alt="(./)" height="16" src="/htdocs/debwiki/img/checkmark.png" title="(./)" width="16" /> Faketime <span class="anchor" id="line-154"></span></li><li><p class="line891"><img alt="(./)" height="16" src="/htdocs/debwiki/img/checkmark.png" title="(./)" width="16" /> Replace <span class="u">TIME</span> with given time in kernel sources (maybe not needed since faketime, however it's cleaner solution to the problem) <span class="anchor" id="line-155"></span></li><li><p class="line891"><img alt="(./)" height="16" src="/htdocs/debwiki/img/checkmark.png" title="(./)" width="16" /> Overlay fix-md5sums-sort.patch  <span class="anchor" id="line-156"></span></li><li><p class="line891"><img alt="(./)" height="16" src="/htdocs/debwiki/img/checkmark.png" title="(./)" width="16" /> Overlay fix-remove-debuglink.patch (probably not needed because of <a class="http" href="http://anonscm.debian.org/gitweb/?p=reproducible/debhelper.git;a=shortlog;h=refs/heads/pu/reproducible_builds">pu/reproducible_builds</a> debhelper) <span class="anchor" id="line-157"></span></li><li><p class="line891"><img alt="(./)" height="16" src="/htdocs/debwiki/img/checkmark.png" title="(./)" width="16" /> Overlay fix-kpkg-gz.patch (probably not needed because of <a class="http" href="http://anonscm.debian.org/gitweb/?p=reproducible/debhelper.git;a=shortlog;h=refs/heads/pu/reproducible_builds">pu/reproducible_builds</a> dpkg) <span class="anchor" id="line-158"></span></li><li><p class="line891"><img alt="(./)" height="16" src="/htdocs/debwiki/img/checkmark.png" title="(./)" width="16" /> Overlay fix-deterministic-buildinfo.patch <span class="anchor" id="line-159"></span></li><li><p class="line891"><img alt="(./)" height="16" src="/htdocs/debwiki/img/checkmark.png" title="(./)" width="16" /> <a class="http" href="http://kernelnewbies.org/BuildId">build-id</a>  <span class="anchor" id="line-160"></span><ul><li><p class="line891"><img alt="(./)" height="16" src="/htdocs/debwiki/img/checkmark.png" title="(./)" width="16" /> Change to build-id=none for vmlinux to fix it quickly <span class="anchor" id="line-161"></span></li><li><p class="line891"><img alt="(./)" height="16" src="/htdocs/debwiki/img/checkmark.png" title="(./)" width="16" /> Check exact version of libc6, gcc, and other tools that embed their name in elf binaries in headers package <span class="anchor" id="line-162"></span></li><li>Turn back on buildid for vmlinux, if the exact versions are forced then it should be the same each time? (TODO) <span class="anchor" id="line-163"></span></li></ul></li><li><p class="line891"><img alt="(./)" height="16" src="/htdocs/debwiki/img/checkmark.png" title="(./)" width="16" /> Tar --mtime and sorting files are managed by reproducible dpkg  <span class="anchor" id="line-164"></span></li><li><p class="line891"><img alt="(./)" height="16" src="/htdocs/debwiki/img/checkmark.png" title="(./)" width="16" /> Deterministic ar is set by reproducible dpkg  <span class="anchor" id="line-165"></span></li><li><p class="line891"><img alt="(./)" height="16" src="/htdocs/debwiki/img/checkmark.png" title="(./)" width="16" /> Force always same XZ options: CRC and compression in <a href="/Mempo/mempo-deb#dpkg">our dpkg</a> from Mempo <span class="anchor" id="line-166"></span><span class="anchor" id="line-167"></span><span class="anchor" id="line-168"></span></li></ul><p class="line867">
<h2 id="Trust_chain">Trust chain</h2>
<span class="anchor" id="line-169"></span><span class="anchor" id="line-170"></span><p class="line862">For <a href="/Mempo">Mempo</a>-Kernel: obtain the *.deb from mempo repository, then check checksum of it with trustworthy people who did build *.deb from source and check if it produces same binary as in repository. <span class="anchor" id="line-171"></span><span class="anchor" id="line-172"></span><ul><li>You: check checksum of *.deb and look for trusted 3rd party signed message that such *.deb is fine. <span class="anchor" id="line-173"></span></li><li>Volunteers: will spend the 2-3 hours needed to build and verify our *.deb and then confirm you can trust the *.deb with given checksum. <span class="anchor" id="line-174"></span><span class="anchor" id="line-175"></span></li></ul><p class="line874">So the full chain trust is: <span class="anchor" id="line-176"></span><ul><li>You should install the *.deb of Kernel <span class="anchor" id="line-177"></span></li><li>If this is the official Debian Kernel, after Debian will use the script/technique described here, then this *.deb is signed by apt-get GPG key so you trust it implicitly - all done and you are able to repeat the build process to verify if the apt-get GPG key was not compromised. <span class="anchor" id="line-178"></span></li><li><p class="line862">If this is for the <a href="/Mempo">Mempo</a>-Kernel, then until this flavour is hopefully included in Official Debian as another kernel option, it is not signed by GPG key of Debian official apt-get. <span class="anchor" id="line-179"></span></li><li><p class="line862">In this case, verify if the *.deb file you downloaded is signed by <a class="mailto" href="mailto:security@mempo.org">security@mempo.org</a> <span class="anchor" id="line-180"></span></li></ul><p class="line862">But how do you verify is <a class="mailto" href="mailto:security@mempo.org">security@mempo.org</a> is not compromised nor malicious? <span class="anchor" id="line-181"></span><ul><li>For this verification, you can build the kernel yourself as described here <span class="anchor" id="line-182"></span></li><li>Compare the content of provided and built *.deb with each other <span class="anchor" id="line-183"></span></li><li>If matching, you can publish that "Kernel *.deb file with checksum sha512:........ was unpacked and verified to match results of compilation from source by me" so others can do it easier. <span class="anchor" id="line-184"></span><span class="anchor" id="line-185"></span></li></ul><p class="line874">In time, we will upgrade the build script to have the final *.deb file identical, then procedure is even faster (just run run.sh and publish sha512 of your *.deb). <span class="anchor" id="line-186"></span><span class="anchor" id="line-187"></span><p class="line867"><a href="/Mempo">Mempo</a> project might release the *.deb in own repository for easy installation for people that want this. <span class="anchor" id="line-188"></span><span class="anchor" id="line-189"></span><p class="line874">Ultimately, Debian.org might one day officially include Mempo-kernel in Debian repository (though, even then checksum based verification will be more secure, in case of ftp master key being compromised). <span class="anchor" id="line-190"></span><span class="anchor" id="line-191"></span><p class="line867"><span class="anchor" id="FAQ"></span> <span class="anchor" id="line-192"></span>
<h2 id="FAQ-1">FAQ</h2>
<span class="anchor" id="line-193"></span><p class="line867"><a href="/SameKernel#FAQ">FAQ</a> posts solutions to common questions and problems: <span class="anchor" id="line-194"></span><span class="anchor" id="line-195"></span><ul><li style="list-style-type:none"><p class="line862">Bugs - read the known <a href="/SameKernel#bugs">#bugs</a> below first. <span class="anchor" id="line-196"></span><span class="anchor" id="line-197"></span></li><dt>Using kernel: Firefox and other programs do not run</dt><dd><p class="line862">you run then <a href="/SameKernel#grsecurity">#grsecurity</a> version of kernel? You forgot to run the setfattr script, see <a href="/SameKernel#grsecurity">#grsecurity</a> and <a href="/grsecurity/setfattr">grsecurity/setfattr</a>. Currently this script needs to be run AGAIN after reinstalling, upgrading.  <span class="anchor" id="line-198"></span><span class="anchor" id="line-199"></span></dd><dt>Using kernel: Still some things do not run</dt><dd><p class="line862">special programs, some hardware drivers, opengl, opencl could be blocked on this security settings. Other settings of grsecurity in <a href="/Mempo#future">future</a> could be more permissive. Ask us on mempo as well as at #grsecurity. <span class="anchor" id="line-200"></span><span class="anchor" id="line-201"></span></dd><dt>Using kernel: Programs run slower</dt><dd><p class="line862">Grsecurity at high security levels is auditing many system calls and internal operations to make sure even new unknown exploits would be usually blocked. This takes time. We are preparing <a class="nonexistent" href="/grsecurity/#performance">grsecurity/#performance</a> review. Roughly, task like compiling a program could be 20-50% slower. We will prepare more light versions of grsecurity settings in <a href="/Mempo#future">future</a> <span class="anchor" id="line-202"></span><span class="anchor" id="line-203"></span></dd><dt>Build: Wrong version of something</dt><dd><p class="line862">if libc differs a bit then it should work but the binary files can differ similar to what happened in <a href="/SameKernel#bug2">#bug2</a> (that is not our bug - just you need to use correct version of libs). If dpkg, gettext etc - then you must install them as described here. <span class="anchor" id="line-204"></span><span class="anchor" id="line-205"></span></dd><dt>Build: Not enough free space</dt><dd><p class="line862">It will probably run out of disk space. If you would try to fix that and create space on <strong>another partition</strong> then move (or symlink) entire home or the top directory, in the end the working directory must be as expected (at least as of 2014-02-14) script will warn you if the work dir is incorrect. <span class="anchor" id="line-206"></span><span class="anchor" id="line-207"></span></dd><dt>Build: Wrong checksum on file (on linux kernel)</dt><dd><p class="line862">probably file was corrupted in the cached download on your hard drive, in <strong>~/Downloads/linux</strong>... or in kernel-sources/ where you build SameKernel. Delete this partially download file, and script will re-download. <strong>-or-</strong> in rare cases it could mean network download error, or actual attack on you (DNS spoof/network takeover - and sending malicious file instead), in such case back up the file and report people you trust / security researchers <span class="anchor" id="line-208"></span></dd><dt>Build: Wrong checksum on file (other file, included in SameKernel)</dt><dd>files corrupted on disk, or mistake in our script/sources listing. Contact us <span class="anchor" id="line-209"></span></dd><dt>Build: Wrong dpkg version</dt><dd>do as the error message says. <span class="anchor" id="line-210"></span></dd><dt>Can not run as root</dt><dd>do as the error message says. <span class="anchor" id="line-211"></span></dd><dt>Build: Wrong username</dt><dd>do as the error message says. <span class="anchor" id="line-212"></span></dd><dt>Build: Wrong directory</dt><dd>do as the error message says. <span class="anchor" id="line-213"></span><span class="anchor" id="line-214"></span></dd></ul><p class="line867"><span class="anchor" id="bugs"></span> <span class="anchor" id="line-215"></span><span class="anchor" id="line-216"></span><p class="line867">
<h2 id="Bugs">Bugs</h2>
<span class="anchor" id="line-217"></span><span class="anchor" id="line-218"></span><p class="line867"><span class="anchor" id="bug1"></span> <span class="anchor" id="line-219"></span>
<h3 id="bug1_.5Blow.5D_.5Bopen.5D_gzip_problem_while_building_from_source">bug1 [low] [open] gzip problem while building from source</h3>
<span class="anchor" id="line-220"></span><span class="anchor" id="line-221"></span><p class="line867"><a href="/SameKernel#bug1">#bug1</a> Error unknown option '-' to gzip:: error caused by <strong>unknown problem</strong>, seen by us 3 time so far, please tell us on IRC if you see it too.  <span class="anchor" id="line-222"></span><span class="anchor" id="line-223"></span><p class="line862">Please help us debug it if you can, e.g. <tt>strace&nbsp;-s&nbsp;8192&nbsp;-fff&nbsp;-o&nbsp;strace&nbsp;run.sh</tt> and look how is gzip executed, does it get invalid arguments. <span class="anchor" id="line-224"></span><span class="anchor" id="line-225"></span><p class="line874">It was said it could be related to redirections and redirecting to null could help (but perhaps not). <span class="anchor" id="line-226"></span><span class="anchor" id="line-227"></span><p class="line867"><span class="anchor" id="bug2"></span> <span class="anchor" id="line-228"></span>
<h3 id="bug2_.5Bvery-low.5D_.5Bfixed.3F.5D_Headers_checksum_not_matching_since_fixdep_has_other_gcc_name">bug2 [very-low] [fixed?] Headers checksum not matching since fixdep has other gcc name</h3>
<span class="anchor" id="line-229"></span><span class="anchor" id="line-230"></span><p class="line867"><a href="/SameKernel#bug2">#bug2</a> not matching checksum of the deb with headers, just the gcc name differs <span class="anchor" id="line-231"></span><span class="anchor" id="line-232"></span><p class="line867"><strong>Solution</strong>: you must have identical version of tools that have their version embed in binaries during compilation - especially <strong>gcc and libc6</strong>. Now script will partially try to detect/warn you. Simply run system update before building. If you try to build older kernel it might be harder, you would need correct versions of libs - or instead compare by hand as explained in next paragraphs. <span class="anchor" id="line-233"></span><span class="anchor" id="line-234"></span><p class="line874">Impact: just makes it harder to produce-verification (but despite that you can just trust that other people your trust said source==kernel) <span class="anchor" id="line-235"></span><span class="anchor" id="line-236"></span><p class="line874">Info: the headers deb is sometimes different, between systems; It turn out that some of binary programs there like fixdep have embbed other exact name/version of gcc compiler. <span class="anchor" id="line-237"></span><span class="anchor" id="line-238"></span><p class="line867"><em>News:</em> seems to be result of differences in libc library package, will add check for it in run.sh <span class="anchor" id="line-239"></span><span class="anchor" id="line-240"></span><p class="line874">Workaround: update fully your system before building (and in retrospection - use identical version that developers used). <span class="anchor" id="line-241"></span>Workaround: unpack your deb and the orginal deb and inspect diff, only the binaries should differ, and with command you can check the problem: <span class="anchor" id="line-242"></span><span class="anchor" id="line-243"></span><span class="anchor" id="line-244"></span><span class="anchor" id="line-245"></span><span class="anchor" id="line-246"></span><span class="anchor" id="line-247"></span><pre><span class="anchor" id="line-1-9"></span>&lt;vyrly@oftc&gt; Can check GCC version easly using command:  readelf -p .comment fixdep
<span class="anchor" id="line-2-3"></span>&lt;tefnoot@oftc&gt; String dump of section '.comment':
<span class="anchor" id="line-3-2"></span>&lt;tefnoot@oftc&gt;   [     0]  GCC: (Debian 4.7.2-5) 4.7.2
<span class="anchor" id="line-4-2"></span>&lt;tefnoot@oftc&gt;   [    1c]  GCC: (Debian 4.4.7-2) 4.4.7</pre><span class="anchor" id="line-248"></span><p class="line874">also you can hexdump the both binaries and diff them, it should be like: <span class="anchor" id="line-249"></span><span class="anchor" id="line-250"></span><span class="anchor" id="line-251"></span><span class="anchor" id="line-252"></span><span class="anchor" id="line-253"></span><span class="anchor" id="line-254"></span><span class="anchor" id="line-255"></span><span class="anchor" id="line-256"></span><span class="anchor" id="line-257"></span><span class="anchor" id="line-258"></span><span class="anchor" id="line-259"></span><pre><span class="anchor" id="line-1-10"></span>&lt;rfree&gt; -000022f0  20 28 44 65 62 69 61 6e  20 34 2e 34 2e 37 2d 33  | (Debian 4.4.7-3|
<span class="anchor" id="line-2-4"></span>&lt;rfree&gt; +000022f0  20 28 44 65 62 69 61 6e  20 34 2e 34 2e 37 2d 32  | (Debian 4.4.7-2|
<span class="anchor" id="line-3-3"></span>
<span class="anchor" id="line-4-3"></span>but also this line, it's probably same info about version but in binary (int?)
<span class="anchor" id="line-5"></span>
<span class="anchor" id="line-6"></span>-00000240  14 00 00 00 03 00 00 00  47 4e 55 00 9c 99 41 b2  |........GNU...A.|
<span class="anchor" id="line-7"></span>-00000250  36 53 75 44 d1 54 57 84  cd 01 f0 2b 84 17 a2 27  |6SuD.TW....+...'|
<span class="anchor" id="line-8"></span>+00000240  14 00 00 00 03 00 00 00  47 4e 55 00 ad 80 0e 61  |........GNU....a|
<span class="anchor" id="line-9"></span>+00000250  2c ee 29 52 92 10 8f f0  09 90 e3 e3 42 2d 4b 36  |,.)R........B-K6|</pre><span class="anchor" id="line-260"></span><span class="anchor" id="line-261"></span><p class="line874">Though above is not 100% guaranteed the difference is not a trojan. Perhaps further assembler analysis of that section can prove it (readelf) <span class="anchor" id="line-262"></span><span class="anchor" id="line-263"></span><p class="line874">Research: this happens even if dpkg says gcc, gcc-4.7 are same. Some other packages are involved. <span class="anchor" id="line-264"></span><span class="anchor" id="line-265"></span><p class="line874">More details: <span class="anchor" id="line-266"></span><ul><li><p class="line891"><a class="https" href="https://p.suchdig.com/p/cwc-hexdiff.txt">https://p.suchdig.com/p/cwc-hexdiff.txt</a> <span class="anchor" id="line-267"></span></li><li><p class="line891"><a class="https" href="https://p.suchdig.com/p/cua.txt">https://p.suchdig.com/p/cua.txt</a> <span class="anchor" id="line-268"></span></li><li><p class="line891"><a class="https" href="https://p.suchdig.com/p/ctl.txt">https://p.suchdig.com/p/ctl.txt</a> <span class="anchor" id="line-269"></span><span class="anchor" id="line-270"></span></li></ul><p class="line867">
<h2 id="Test">Test</h2>
<span class="anchor" id="line-271"></span><span class="anchor" id="line-272"></span><p class="line862">Tests - please test this script and report any problems to <a href="/Mempo">Mempo</a> and on IRC #mempo also add here to wiki in <a href="/SameKernel/Test">/Test</a> : <span class="anchor" id="line-273"></span><ul><li><p class="line891"><a href="/SameKernel/Test">/Test</a> <span class="anchor" id="line-274"></span><span class="anchor" id="line-275"></span></li></ul><p class="line867"><a href="/CategoryKernel">CategoryKernel</a> <span class="anchor" id="line-276"></span><span class="anchor" id="bottom"></span></div><p id="pageinfo" class="info" lang="en" dir="ltr">SameKernel  (last edited 2014-02-16 11:00:46 by <span title="Mempo"><a href="/Mempo" title="Mempo">Mempo</a></span>)</p>
<div id="pagebottom"></div>
</div>
</body>
</html>

